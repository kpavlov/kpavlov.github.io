---
layout: post
title: "API Authentication: Generating HMAC digest in PHP and Java"
date: 2015-05-20T22:24:47
tags:
  - programming
  - java
  - php
  - security
categories:
  - programming
---

User authentication is an important part of the web service API design.
One of the common approach is the Hash-based Message Authentication Code -- <abbr title="Hash-based Message Authentication Code">[HMAC][wiki]</abbr>.
Used together with transport level security it provides reliable mechanizm of user authentication and message integrity validation.
<!--more-->

Imagine, we want to create java web service for our customers.
Data encryption will be guaranteed by using https connection with TLS.
We will implement API user authentication by using public _API Key ID_ and a _API Key Secret_.
User should generate an API Key: unique pair of _Key ID_ and a _Key Secret_ for his application.
User should send that _Key ID_, message payload and a _digest_ with every request.
Digest is generated by signing all HTTP headers and message payload with _Key Secret_. 
(see [Amazon's recommendations][amazon])

In PHP there is a function [`hash_hmac`][hash_hmac] for generating keyed hash value using the HMAC method. Here is the example:

~~~php
<?php

$keyId = 'd36cb306-9341-466f-a794-d49fbc485d8b';
$payload = '{"command": "buy", "amount":10, currency":"EURUSD"}';
$secret = 'se1cr2et3w0r4d';

echo 'SHA-512 HMAC Digest: ', hash_hmac('sha512', $keyId . $payload, $secret);
~~~

Output:

    SHA-512 HMAC Digest: 577a7927f55bc6ed1eaec08f7298e7c7596b6f951c4c6e8f24324fd9a1f0790adfdecbbd5ab73ad543fec7e6c3c23246a5dd8fae526e0b802ae99faccd06a29c

Call PHP function [`hash_algos`][hash_algos] to get a list of supported algorithms.

How to validate the digest in Java:

~~~java
String apiKey = ... // X-KEY
byte[] secret = ... // 
String rawPayload = ... 
String receivedDigest = ... //
...

Mac digest = Mac.getInstance("HmacSHA512");
SecretKeySpec secretKey = new SecretKeySpec(secret, HMAC_SHA_512);

digest.init(secretKey);
digest.update(apiKey.getBytes(StandardCharsets.UTF_8));
digest.update(rawPayload.getBytes(StandardCharsets.UTF_8));
final byte[] expectedDigest = digest.doFinal();
digest.reset();

final byte[] receivedDigestBytes = DatatypeConverter.parseHexBinary(receivedDigest);
if (!MessageDigest.isEqual(receivedDigestBytes, expectedDigest)) {
    // invalid digest
}
~~~

## References

- [Amazon: Signing and Authenticating REST Requests][amazon]
- [OCLC: HMAC Signature](https://www.oclc.org/developer/develop/authentication/hmac-signature.en.html)
- [Coinbase: API Key Authentication](https://developers.coinbase.com/docs/wallet/api-key-authentication)
- [The RESTful CookBook: HMAC](http://restcookbook.com/Basics/loggingin/)

[hash_hmac]:  http://php.net/manual/en/function.hash-hmac.php
[hash_algos]: http://php.net/manual/en/function.hash-algos.php
[wiki]: http://en.wikipedia.org/wiki/Hash-based_message_authentication_code "Hash-based message authentication code" 
[amazon]: http://docs.aws.amazon.com/AmazonS3/latest/dev/RESTAuthentication.html#ConstructingTheCanonicalizedResourceElement "Signing and Authenticating REST Requests by Amazon"
